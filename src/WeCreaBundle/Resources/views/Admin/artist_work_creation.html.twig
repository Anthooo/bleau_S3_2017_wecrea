{% extends "base.html.twig" %}

{% block body %}

    <div class="container">
        <div class="row">
            <h4>Création d'un nouveau profil</h4>
            {{ form_start(form, {'attr': {'enctype' : 'multipart/form-data' , 'class' : 'col s12'}} ) }}
                <div class="row">
                    <div class="input-field col s12 m6">
                        {{ form_label(form.name, 'Nom Artiste') }}
                        {{ form_widget(form.name) }}
                        {{ form_errors(form.name) }}
                    </div>
                    <div class="input-field col s12 m6">
                        {{ form_label(form.firstname, 'Prénom Artiste') }}
                        {{ form_widget(form.firstname) }}
                        {{ form_errors(form.firstname) }}
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12 m6">
                        {{ form_label(form.localization, 'Localisation Artiste') }}
                        {{ form_widget(form.localization) }}
                        {{ form_errors(form.localization) }}
                    </div>
                    <div class="input-field col s12 m6">
                        {{ form_label(form.expertise, 'Expertise Artiste') }}
                        {{ form_widget(form.expertise) }}
                        {{ form_errors(form.expertise) }}
                    </div>
                </div>

            <button class="btn waves-effect waves-light right" type="submit" name="action">
                Créer le profil
                <i class="material-icons left">send</i>
            </button>
            {{ form_end(form) }}

            {{ form_start(formImage, {'attr' : {'id' : 'artist-picture'}} ) }}
            <div class="row">
                <div class="col s6">
                    {{ form_label(formImage.url, "Photo de l'artiste") }}
                    {{ form_widget(formImage.url) }}
                    {{ form_errors(formImage.url) }}
                </div>
                <div class="row">
                    <div class="col s6" id="images-artist-check">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    {{ form_label(formImage.alt, "Description de la photo") }}
                    {{ form_widget(formImage.alt) }}
                    {{ form_errors(formImage.alt) }}
                </div>
            </div>
            <button class="btn waves-effect waves-light right" type="submit" name="action">
                Ajouter l'image
                <i class="material-icons left">done</i>
            </button>
            <div class="row">
                <h4>Images de l'artiste validées</h4>
                <div class="col s12" id="images-artist-confirmed">
                </div>
                <div id="alertDeleteImage">
                </div>
            </div>
            {{ form_end(formImage) }}
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    <script>
    $(document).ready(function(){
        /* We stock the picture(s) id(s) when created */
        var idImg = [];

        /* We stock the artist id when created */
        var idArt;

        /* We add a preview image instantly */
        $("#wecreabundle_images_url").change(function(){
            var $file = $(this)[0].files[0];
            var $img = $(document.createElement('img'));
            $img.attr('src', window.URL.createObjectURL($file));
            $("#images-artist-check").append($img);
        });

        /* If the image form is submitted */
        $('form[id="artist-picture"]').submit(function(e){
            e.preventDefault();
            var data = new FormData($(this)[0]);

            /* We remove the preview image and reset the
            * form to enable the submission of new pictures
            */
            $img = $("#images-artist-check").find('img');
            $img.remove();
            $(this).trigger('reset');

            /* We store the image into the database then we send it back to the client
            * We now have its id, that will be useful if the client changes its mind and
            * wants to delete it.
            * Moreover, it will serve to associate the images with the artist
            * as they are created separately
            */
            $.ajax({
                url: "{{ path('we_crea_admin_artist_image_creation_ajax') }}",
                method: "post",
                data: data,
                processData: false,
                contentType: false,
                success: function(response){
                    var id = response.id

                    /* We stock all the images' id into an array */
                    idImg.push(id);

                    $img = $(document.createElement('img'));
                    $img.attr("src", "{{ asset('bundles/wecrea/images/')}}"+response.url+"");
                    $img.attr('id', ''+ id +'');

                    /* Creation of a button to delete the image */
                    $cancel = $('<button></button>');
                    $cancel.prop('class' , 'btn waves-effect waves-light left red');
                    $cancel.prop('id' , 'deleteImage');
                    $cancel.text("Supprimer");

                    $("#images-artist-confirmed").append($img);
                    $img.hide().fadeIn(2000);

                    $("#images-artist-confirmed").append($cancel);
                    $cancel.hide().fadeIn(2000);

                    $('#deleteImage').click(function(e){
                        e.preventDefault();
                        var $id = $(this).prev().attr('id');
                        $.ajax({
                            method: 'post',
                            url: "{{ path('we_crea_admin_delete_artist_image_ajax') }}",
                            data : {id : $id, idArt : $idArt},
                            success: function (response){
                                alert(response);
                            }
                        })
                    });
                }
            });
        });
    });
    </script>
{% endblock %}