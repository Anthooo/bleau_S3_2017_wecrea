{% extends "@WeCrea/layout/base_admin.html.twig" %}

{% block body %}
<div class="container">
    <h4>Edition de l'oeuvre {{ work.title }} </h4>
    <div class="row">
            <div class="row row-artist-work-custom">
                {{ form_start(edit_form) }}

                <div class="input-field col s12">
                    {{ form_label(edit_form.title, "Titre") }}
                    {{ form_errors(edit_form.title) }}
                    {{ form_widget(edit_form.title) }}
                </div>
                <div class="col s12">
                    {{ form_label(edit_form.description, "Description") }}
                </div>
                <div class="input-field col s12">
                    {{ form_errors(edit_form.description) }}
                    {{ form_widget(edit_form.description ) }}
                </div>
                <div class="input-field col s12">
                    {{ form_label(edit_form.technic, 'Technique utilisée') }}
                    {{ form_errors(edit_form.technic) }}
                    {{ form_widget(edit_form.technic ) }}
                </div>
                <div class="input-field col s12">
                    {{ form_label(edit_form.timelimit, "Délai de livraison") }}
                    {{ form_errors(edit_form.timelimit) }}
                    {{ form_widget(edit_form.timelimit) }}
                </div>
                <div class="input-field col s12">
                    {{ form_errors(edit_form.nature) }}
                    {{ form_widget(edit_form.nature) }}
                    {{ form_label(edit_form.nature, "Nature de l'oeuvre") }}
                </div>
                <button class="btn waves-effect waves-light right update-work" type="submit" name="action">
                    Éditer l'oeuvre
                    <i class="material-icons left">mode_edit</i>
                </button>
                {{ form_end(edit_form) }}
            </div>


            <div class="row row-custom-edit-work-image">
                <input type="hidden" class="idWork" value="{{ work.id }}"/>
                <h5>Image de l'oeuvre {{ work.title }}</h5>
                {% for image in work.images %}
                    <div class="input-field col s12">
                        <img src="{{ asset('images/'~image.url) }}"/>
                        <input type="hidden" class="idImg" value="{{ image.url }}"/>
                    </div>
                    <div class="col s12">
                        <button class="btn waves-effect waves-light red delete-work-image" type="submit" name="action">
                            Supprimer l'image
                            <i class="material-icons left">delete</i>
                        </button>
                    </div>
                {% endfor %}
            </div>

        {{ form_start(image_form, {'attr' : {'id' : 'add-image-form'}} ) }}
        <div class="row">
            <div class="file-field file-field-custom input-field col s12">
                <div class="btn">
                    <span>Choisissez un fichier</span>
                    <input type="file">
                </div>
                <div class="file-path-wrapper">
                    {{ form_widget(image_form.url, {'attr' : {'class' : 'file-path validate', 'type' : 'text'}} ) }}
                </div>
                {{ form_errors(image_form.url) }}
            </div>

            <div class="col s12" id="add-image-work-check">
            </div>

            <div class="input-field col s12">
                {{ form_label(image_form.alt, "Description de la photo") }}
                {{ form_widget(image_form.alt) }}
                {{ form_errors(image_form.alt) }}
            </div>

            <div class="input-field col s12">
                <button class="btn waves-effect waves-light right green" type="submit" name="action">
                    Ajouter l'image
                    <i class="material-icons left">done</i>
                </button>
            </div>
        </div>
        {{ form_end(image_form) }}

        <div class="row">
            <h4>Nouvelles images de l'oeuvre validées</h4>
            <div class="col s12" id="images-work-confirmed">
            </div>
        </div>

    </div>
</div>
{% endblock %}
{% block javascripts %}
    <script>
        $(document).ready(function(){
            idWork = {{ work.id }}

            /* Enables the select input in materialize */
            $('select').material_select();

            /******** EDITION ********/

            $('form[name="wecreabundle_work"] .update-work').click(function(e){
                e.preventDefault();
                var $data = $(this).parent().serialize();

                var url = "{{ path('we_crea_admin_works_edit', {id : 0} ) }}";
                url = url.replace('0', idWork);

                $.ajax({
                    method: "post",
                    url: url,
                    data: $data,
                    success: function(response){
                        alert(response);
                    }
                });
            });

            /******** DELETE AN IMAGE ********/

            $('.delete-work-image').click(function(){
                var $idImg = $(this).parent().prev().find('input[class="idImg"]').attr('value');

                var $data = {idImg : $idImg, idWork : idWork};

                /* Let's remove the image that would otherwise still be on the page without refresh */
                $(this).parent().prev().remove();
                $(this).remove();

                $.ajax({
                    method: "post",
                    url: "{{ path('we_crea_admin_delete_work_image_ajax') }}",
                    data: $data,
                    success: function(response){
                        alert(response);
                    }
                });
            });

            /* Display the image before submitting the last work new image */
            $("#add-image-form input[id='wecreabundle_images_url']").change(function(){
                var $file = $(this)[0].files[0];
                var $img = $(document.createElement('img'));
                $img.attr('src', window.URL.createObjectURL($file));

                var $button = $(document.createElement('button'));
                $button.attr('class', 'btn waves-effect waves-light red F');
                $button.text('Supprimer');

                $("#add-image-work-check").append($img, $button);

                $button.click(function(){
                    $('form[id="artist-picture"]').trigger('reset');
                    $img.remove();
                    $(this).remove();
                });
            });

            /* Image form linked to already existing works */
            $('form[id="add-image-form"]').submit(function(e){
                e.preventDefault();
                var $idWork = $(this).find('input[name="idWork"]').attr('value');
                var $data = new FormData($(this)[0]);

                /* We remove the preview image and reset the
                 * form to enable the submission of new pictures
                 */

                var $img = $("#add-image-work-check").find('img');
                var $button = $("#add-image-work-check").find('button');
                $img.remove();
                $button.remove();
                $(this).trigger('reset');

                /* We store the image into the database then we send it back to the client
                 * We now have its id, that will be useful if the client
                 * changes its mind and wants to delete it.
                 * Moreover, it will serve to associate the images to the artist
                 * as they are created separately
                 */

                $.ajax({
                    method: 'post',
                    data: $data,
                    contentType: false,
                    processData: false,
                    success: function(response){
                        var $url = response.url;

                        $place = $('#images-work-confirmed');
                        console.log($url);
                        var $newWorkImg = $(document.createElement('div'));
                        $newWorkImg.attr('class', 'input-field col s12');

                        /* Creation of the image with the data returned */
                        var $img = $(document.createElement('img'));
                        $img.attr("src", "{{ asset('images/')}}"+response.url+"");
                        $img.attr('id', ''+ $url +'');

                        var $inputHiddenImg = $(document.createElement('input'));
                        $inputHiddenImg.attr({
                            'type' : 'hidden',
                            'class' : 'idImg',
                            'value' : '' + response.url + '',
                        });

                        /* Creation of an hidden input containing the work id */
                        var $inputHiddenWork = $(document.createElement('input'));
                        $inputHiddenWork.attr({
                            'type' : 'hidden',
                            'class' : 'idWork',
                            'value' : '' + idWork + '',
                        });

                        $newWorkImg.append($img, $inputHiddenImg, $inputHiddenWork);

                        var $newDeleteImgButton = $(document.createElement('div'));
                        $newDeleteImgButton.attr('class', 'col s12');

                        /* Creation of a button to delete the image */
                        var $cancel = $(document.createElement('button'));
                        $cancel.attr({
                            'class': 'btn waves-effect waves-light red delete-work-image',
                            'name' : 'action',
                            'type' : 'submit'
                        });
                        $cancel.text("Supprimer L'image");

                        var $iElt = $(document.createElement('i'));
                        $iElt.attr({
                            'class' : 'material-icons left'
                        });
                        $iElt.text('delete');

                        $cancel.append($iElt);
                        $newDeleteImgButton.append($cancel);

                        /* We append the new image to the div containing all the images
                         * linked to the work
                         * We need to get the id of the work which is in the div
                         */

                        $newWorkImg.insertBefore($place);
                        $newDeleteImgButton.insertBefore($place);
                        $newWorkImg.hide().fadeIn(2000);
                        $newDeleteImgButton.hide().fadeIn(2000);


                        $('.delete-work-image').click(function(e){
                            e.preventDefault();
                            var $idImg = $(this).parent().prev().find('input[class="idImg"]').attr('value');
                            var $idWork = $(this).parent().prev().find('input[class="idWork"]').attr('value');

                            var $data = {idImg : $idImg, idWork : $idWork};

                            /* Let's remove the image that would otherwise still be on the page without refresh */
                            $(this).parent().prev().remove();
                            $(this).remove();

                            $.ajax({
                                method: "post",
                                url: "{{ path('we_crea_admin_delete_work_image_ajax') }}",
                                data: $data,
                                success: function(response){
                                    alert(response);
                                }
                            });
                        });
                    }
                });
            });
        });
    </script>
{% endblock %}